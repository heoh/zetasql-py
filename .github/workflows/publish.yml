name: Publish to PyPI

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish:
    # Skip pre-releases
    if: "!github.event.release.prerelease"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          python << 'EOF'
          import re
          from datetime import datetime

          VERSION = "${{ steps.version.outputs.version }}"
          DATE = "${{ steps.version.outputs.date }}"

          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Find previous version from CHANGELOG
          version_pattern = r'## \[(\d+\.\d+\.\d+)\]'
          matches = re.findall(version_pattern, content)
          prev_version = matches[0] if matches else "0.1.0"

          # Replace [Unreleased] with new version
          content = re.sub(
              r'## \[Unreleased\]',
              f'## [{VERSION}] - {DATE}',
              content,
              count=1
          )

          # Add new [Unreleased] section at the top (after header)
          header_end = content.find('## [')
          if header_end != -1:
              before_first_section = content[:header_end]
              after_first_section = content[header_end:]
              new_unreleased = "## [Unreleased]\n\n### Added\n\n### Changed\n\n### Documentation\n\n### Testing\n\n"
              content = before_first_section + new_unreleased + after_first_section

          # Update links at the bottom
          # Update [Unreleased] link to compare with new version
          content = re.sub(
              r'\[Unreleased\]: https://github\.com/heoh/zetasql-py/compare/v[\d\.]+\.\.\.HEAD',
              f'[Unreleased]: https://github.com/heoh/zetasql-py/compare/v{VERSION}...HEAD',
              content
          )

          # Add new version link (compare with previous version)
          unreleased_link_match = re.search(r'(\[Unreleased\]: .+\n)', content)
          if unreleased_link_match:
              insert_pos = unreleased_link_match.end()
              new_version_link = f'[{VERSION}]: https://github.com/heoh/zetasql-py/compare/v{prev_version}...v{VERSION}\n'
              content = content[:insert_pos] + new_version_link + content[insert_pos:]

          with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
              f.write(content)

          print(f"✅ Updated CHANGELOG.md: [Unreleased] → [{VERSION}] - {DATE}")
          print(f"✅ Previous version detected: v{prev_version}")
          EOF

      - name: Update pyproject.toml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
          echo "✅ Updated pyproject.toml to version $VERSION"

      - name: Update __version__.py
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^__version__ = \".*\"/__version__ = \"$VERSION\"/" src/zetasql/__version__.py
          echo "✅ Updated __version__.py to version $VERSION"

      - name: Commit changes and amend tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md pyproject.toml src/zetasql/__version__.py
          git commit --amend --no-edit

          TAG="${{ steps.version.outputs.tag }}"
          git tag -f "$TAG"
          git push -f origin "$TAG"

          echo "✅ Amended commit and force-pushed tag $TAG"

      - name: Build package
        run: |
          python -m build
          echo "✅ Built package"
          ls -lh dist/

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
